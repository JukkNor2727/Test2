<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chemical Stock Manager (GoogleÂ Sheet)</title>
  <style>
    :root {
      --bg: #f0f9ff;
      --card: #ffffff;
      --primary: #0d9488;
      --border: #d1d5db;
      --danger: #fee2e2;
      --warn:  #fef9c3;
      --ok:    #dcfce7;
      --font:  'Prompt', sans-serif;
    }

    body {
      background: var(--bg);
      font-family: var(--font);
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    h1 { margin: 0 0 8px; font-weight: 600; color: var(--primary); }

    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 16px;
      border: 1px solid var(--primary);
      background: var(--primary);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }

    .card {
      background: var(--card);
      width: 100%;
      max-width: 1200px;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 18px rgb(0 0 0 / .08);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 600px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th { background: var(--primary); color: #fff; position: sticky; top: 0; }
    td[contenteditable="true"] { background: #fffbe6; }
    tr.new-row td { background: var(--warn); }
  </style>
</head>
<body>
  <h1>Chemical Stock Manager</h1>

  <div class="toolbar">
    <button id="loadBtn">Load from Sheet</button>
    <button id="saveBtn">Save Changes</button>
    <button id="addBtn">Add Blank Row</button>
  </div>

  <div class="card">
    <table id="sheetTable"></table>
  </div>

<script>
// ----------------- CONFIG -----------------
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxV0V7KMQ7kPaFeocyBWS1x_UjSUo3TFxs_84T9QSUKwICNujIh9pc_X_yO-uYHYHD3/exec';

// ------------ STATE --------------
let snapshot = [];      // deepâ€‘clone à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸Â Sheet
let headers  = [];      // column order à¸•à¸²à¸¡ header à¹à¸–à¸§Â 1 à¸‚à¸­à¸‡Â Sheet

// ------------ HELPERS ------------
const $ = (id) => document.getElementById(id);

function notify(msg, ms = 2500) {
  const div = document.createElement('div');
  div.textContent = msg;
  Object.assign(div.style, {
    position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)',
    background: 'var(--primary)', color: '#fff', padding: '8px 14px', borderRadius: '8px',
    boxShadow: '0 2px 6px rgb(0 0 0 / .2)', zIndex: 9999, transition: 'opacity .3s'
  });
  document.body.appendChild(div);
  setTimeout(() => { div.style.opacity = '0'; }, ms - 300);
  setTimeout(() => div.remove(), ms);
}

// ------------ LOAD DATA ------------
async function loadData() {
  $('loadBtn').disabled = true;
  try {
    const res  = await fetch(ENDPOINT);
    const rows = await res.json();              // array of objects
    if (!rows.length) return renderTable([], []);
    headers    = Object.keys(rows[0]);
    snapshot   = JSON.parse(JSON.stringify(rows));  // deepâ€‘clone
    renderTable(rows, headers);
    notify('ðŸ“¥ Data loaded');
  } catch (err) {
    console.error(err);
    alert('à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ\n' + err.message);
  } finally {
    $('loadBtn').disabled = false;
  }
}

// ------------ RENDER TABLE ------------
function renderTable(rows, hdrs) {
  const tbl = $('sheetTable');
  if (!rows.length) {
    tbl.innerHTML = '<tr><td>No data</td></tr>';
    return;
  }
  // build header
  tbl.innerHTML = '<thead><tr>' + hdrs.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody></tbody>';
  const tbody = tbl.tBodies[0];

  rows.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.innerHTML = hdrs.map(h => {
      const editable = h !== 'id' ? 'contenteditable="true"' : '';
      return `<td ${editable}>${row[h] ?? ''}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
}

// ------------ SAVE DATA (diff only) ------------
async function saveData() {
  $('saveBtn').disabled = true;
  try {
    const changed = collectChanges();
    if (!changed.length) return notify('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡');

    const res = await fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(changed)
    });
    const msg = await res.json();
    notify(`âœ… Updated rows: ${msg.updated}`);
    await loadData();   // à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸ªà¸£à¹‡à¸ˆ
  } catch (err) {
    console.error(err);
    alert('à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ\n' + err.message);
  } finally {
    $('saveBtn').disabled = false;
  }
}

function collectChanges() {
  const tblRows = [...$('sheetTable').tBodies[0].rows];
  const mods = [];

  tblRows.forEach((tr, i) => {
    const obj = {};
    [...tr.cells].forEach((td, j) => obj[headers[j]] = td.textContent.trim());

    const original = snapshot[i];
    // à¸–à¹‰à¸² original à¹„à¸¡à¹ˆà¸¡à¸µ à¹à¸›à¸¥à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¹à¸–à¸§à¹ƒà¸«à¸¡à¹ˆ
    if (!original) {
      if (!obj.id) obj.id = `new_${Date.now()}_${i}`; // à¸ªà¸£à¹‰à¸²à¸‡ id à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ
      tr.classList.remove('new-row');
      mods.push(obj);
      return;
    }

    const diff = headers.some(h => String(obj[h]) !== String(original[h]));
    if (diff) mods.push(obj);
  });
  return mods;
}

// ------------ ADD BLANK ROW ------------
function addBlankRow() {
  if (!headers.length) return alert('à¸à¸£à¸¸à¸“à¸² Load à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¹ˆà¸­à¸™');
  const tbl   = $('sheetTable');
  const tbody = tbl.tBodies[0];
  const tr    = document.createElement('tr');
  tr.classList.add('new-row');
  tr.innerHTML = headers.map(h => {
    return `<td contenteditable="${h !== 'id'}"></td>`;
  }).join('');
  tbody.appendChild(tr);
}

// ------------ EVENT BINDINGS ------------
$('loadBtn').addEventListener('click', loadData);
$('saveBtn').addEventListener('click', saveData);
$('addBtn').addEventListener('click', addBlankRow);

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
